$schema: 'https://moonrepo.dev/schemas/project.json'

type: 'application'
language: 'go'

project:
  name: 'temp'
  description: 'A very basic template for a Golang project'

fileGroups:
  sources:
    - 'cmd'
    - 'internal'
    - 'pkg'

tasks:
  clean:
    script: 'rm -rf bin internal/gen pkg/gen'
    options:
      cache: false
  setup:
    script: 'go mod tidy; awk "/^\\s*tool\\s+/ {print \$2}" go.mod | xargs -I {} go install {}'
    inputs:
      - 'go.mod'
  generate:
    script: 'bash scripts/generate.sh'
    inputs:
      - 'configs'
      - 'db/migrations'
      - 'db/queries'
      - 'api/openapi.yml'
      - 'scripts/generate.sh'
    outputs:
      - 'internal/gen'
      - 'pkg/gen'
  format:
    script: 'gofumpt -l -w .; golangci-lint run --fix --allow-parallel-runners --issues-exit-code 0 > /dev/null'
    inputs:
      - '@group(sources)'
  lint:
    script: 'golangci-lint run --allow-parallel-runners; go vet ./...'
    inputs:
      - '@group(sources)'
  test:
    command: 'go test ./...'
    inputs:
      - '@group(sources)'
  build:
    env:
      CGO_ENABLED: '0'
      GOOS: 'linux'
      GOARCH: 'amd64'
    script: 'go build -ldflags="-s -w" -trimpath -o bin/server cmd/server/main.go'
    inputs:
      - '@group(sources)'
    outputs:
      - 'bin/server'
  serve:
    script: 'go run ./cmd'
    inputs:
      - '@group(sources)'
  migrate:
    script: 'migrate -source file://db/migrations/ -database "$DATABASE_URL" up'
    options:
      envFile: true
    inputs:
      - 'db/migrations'
